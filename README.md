## Comments

After reading the immunefi article explaining the Aurora bridge vulnerability https://medium.com/immunefi/aurora-infinite-spend-bugfix-review-6m-payout-e635d24273d, I was left with some doubts regarding the events functioning in the context of a delegatecall().

The vulnerability was based on an event generation by a smart contract called by a delegatecall(). To my knowledge, the event should have been generated by the caller contract and not the callee contract, however the vulnerability seemed to suppose the event was used as a trigger to allow the bridging, implicitely designing the callee contract as the origin of the event.

I therefore wanted to validate my understanding of the event generation in the context of a delegatecall() in a pure Ethereum environment (without any Aurora specific layer), and therefore created 2 very basic contracts caller and callee, and a python script to perform the testing.

Result: the event generated by the delegatecall() tx is indeed designing the caller contract as the source of the event. My conclusion is that the Aurora blockchain create some specific events on top of the execution of the contracts, and that the vulnerability was not the result of a typical contract event generation. The article lacks the right level of technical detail to understand the actual context of the vulnerability.


## How to execute the test

Execute scripts/delegate-test.py in Brownie console (v1.19.0 used)

## Example of results

Here is an example of the results given by this test:

*** delegatecall tx ***
- return_tx:  True
- tx events:  {'called': [OrderedDict([('msg_sender', '0xa23394208835D688C7A757293011B03EAF885Db8'), ('thisAddress', '0x4cf18B8aa899Cf716D5893ffAfbfAbc92955a378')])]}
- callee events:  AttributeDict({'called': []})
- caller events:  AttributeDict({'called': [AttributeDict({'args': AttributeDict({'msg_sender': '0xa23394208835D688C7A757293011B03EAF885Db8', 'thisAddress': '0x4cf18B8aa899Cf716D5893ffAfbfAbc92955a378'}), 'event': 'called', 'logIndex': 0, 'transactionIndex': 0, 'transactionHash': HexBytes('0x3bcf48847719d8883f404241b5cc73a60de4870361e1e9136dedfd5f75a7ec93'), 'address': '0x4cf18B8aa899Cf716D5893ffAfbfAbc92955a378', 'blockHash': HexBytes('0x285ac1e5d812f8b5ef192fdbd01487a5d6a9b9bc0261c9f1bba9f8307832c843'), 'blockNumber': 286})]})
- enum_test after delegatecall:  2
Transaction sent: 0x49bea5cb91d1279349b4d666ccdaf7ce725c6f269c183348dff36e5e229c7e6e
  Max fee: 1.8e-08 gwei   Priority fee: 2e-09 gwei   Gas limit: 30000000   Nonce: 285
  callee.generateEvent confirmed   Block: 287   Gas used: 44621 (0.15%)   Gas price: 1e-08 gwei

*** direct tx ***
- tx_direct events:  {'called': [OrderedDict([('msg_sender', '0xa23394208835D688C7A757293011B03EAF885Db8'), ('thisAddress', '0xf5238d3e3F6e02803A548A7659E4B997859C1ea2')])]}
- callee events:  AttributeDict({'called': [AttributeDict({'args': AttributeDict({'msg_sender': '0xa23394208835D688C7A757293011B03EAF885Db8', 'thisAddress': '0xf5238d3e3F6e02803A548A7659E4B997859C1ea2'}), 'event': 'called', 'logIndex': 0, 'transactionIndex': 0, 'transactionHash': HexBytes('0x49bea5cb91d1279349b4d666ccdaf7ce725c6f269c183348dff36e5e229c7e6e'), 'address': '0xf5238d3e3F6e02803A548A7659E4B997859C1ea2', 'blockHash': HexBytes('0x5b06e770198c4640d59ee634fef442827ce1df0359ae72168d7e417c5dcf8391'), 'blockNumber': 287})]})
- caller events:  AttributeDict({'called': [AttributeDict({'args': AttributeDict({'msg_sender': '0xa23394208835D688C7A757293011B03EAF885Db8', 'thisAddress': '0x4cf18B8aa899Cf716D5893ffAfbfAbc92955a378'}), 'event': 'called', 'logIndex': 0, 'transactionIndex': 0, 'transactionHash': HexBytes('0x3bcf48847719d8883f404241b5cc73a60de4870361e1e9136dedfd5f75a7ec93'), 'address': '0x4cf18B8aa899Cf716D5893ffAfbfAbc92955a378', 'blockHash': HexBytes('0x285ac1e5d812f8b5ef192fdbd01487a5d6a9b9bc0261c9f1bba9f8307832c843'), 'blockNumber': 286})]})
- enum_test after direct call:  2

